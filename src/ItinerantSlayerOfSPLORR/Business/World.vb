Friend Class World
    Implements IWorld
    Private _data As WorldData
    Sub New(data As WorldData)
        _data = data
    End Sub
    Public ReadOnly Property PlayerBoard As IBoard Implements IWorld.PlayerBoard
        Get
            Return New Board(_data.Boards(_data.PlayerData.BoardIndex))
        End Get
    End Property

    Public ReadOnly Property CanContinue As Boolean Implements IWorld.CanContinue
        Get
            Return _data.PlayerData IsNot Nothing
        End Get
    End Property
    Public ReadOnly Property CanAbandon As Boolean Implements IWorld.CanAbandon
        Get
            Return CanContinue
        End Get
    End Property
    Public ReadOnly Property CanStart As Boolean Implements IWorld.CanStart
        Get
            Return Not CanContinue
        End Get
    End Property

    Public ReadOnly Property Player As IPlayer Implements IWorld.Player
        Get
            Return New Player(_data.PlayerData)
        End Get
    End Property

    Friend Sub StartGame() Implements IWorld.StartGame
        AbandonGame()
        InitializeBoards()
        InitializePlayer()
    End Sub

    Private Sub InitializePlayer()
        _data.PlayerData = New PlayerData With {.BoardIndex = 0, .BoardColumn = 6, .BoardRow = 3}
    End Sub

    Private ReadOnly level As IReadOnlyList(Of String) = New List(Of String) From
        {
            "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~",
            "~~~~~~....................................................................................................................................................................................................................................~~~~~~",
            "~~~~........................................................................................................................................................................................................................................~~~~",
            "~~....!.......................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~............................................................................................................................................................................................................................................~~",
            "~~~~........................................................................................................................................................................................................................................~~~~",
            "~~~~~~....................................................................................................................................................................................................................................~~~~~~",
            "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
        }
    Private levelCharacters As IReadOnlyList(Of (CharacterType, Integer, Integer)) =
        New List(Of (CharacterType, Integer, Integer)) From
        {
            (CharacterType.Dude, 6, 3)
        }

    Private Sub InitializeBoards()
        Dim board As IBoard = CreateLevel(level(0).Length, level.Count)

    End Sub

    Private Function CreateLevel(columns As Integer, rows As Integer) As IBoard
        Dim random As New Random
        Dim boardData As New BoardData()
        _data.Boards.Add(boardData)
        boardData.DefaultTerrain = TerrainType.Water
        While boardData.BoardColumns.Count < columns
            Dim column = boardData.BoardColumns.Count
            Dim boardColumnData As New BoardColumnData
            boardData.BoardColumns.Add(boardColumnData)
            While boardColumnData.Cells.Count < rows
                Dim row = boardColumnData.Cells.Count
                Dim boardCellData = New BoardCellData
                boardColumnData.Cells.Add(boardCellData)
                Select Case level(row)(column)
                    Case "."c
                        boardCellData.Terrain = TerrainType.Grass
                    Case "~"c
                        boardCellData.Terrain = TerrainType.Water
                    Case "!"c
                        boardCellData.Terrain = TerrainType.Home
                    Case Else
                        Throw New NotImplementedException
                End Select
            End While
        End While
        For Each character In levelCharacters
            boardData.BoardColumns(character.Item2).Cells(character.Item3).Character = New CharacterData() With
            {
                .CharacterType = character.Item1
            }
        Next
        Dim counter = 0
        Do While counter < DollarCount
            Dim column = random.Next(columns)
            Dim row = random.Next(rows)
            Dim cell = boardData.BoardColumns(column).Cells(row)
            If cell.Character IsNot Nothing OrElse cell.Item IsNot Nothing OrElse cell.Terrain <> TerrainType.Grass Then
                Continue Do
            End If
            counter += 1
            cell.Item = New ItemData() With
            {
                .ItemType = ItemType.Dollar
            }
        Loop
        Return New Board(boardData)
    End Function

    Private Const DollarCount = 100

    Friend Sub AbandonGame() Implements IWorld.AbandonGame
        _data.Boards.Clear()
        _data.PlayerData = Nothing
    End Sub

    Public Sub MoveNorth() Implements IWorld.MoveNorth
        MovePlayer(0, -1)
    End Sub

    Private Sub MovePlayer(deltaX As Integer, deltaY As Integer)
        Dim currentCell = PlayerBoard.GetCell(Player.X, Player.Y)
        Dim nextCell = PlayerBoard.GetCell(Player.X + deltaX, Player.Y + deltaY)
        If nextCell Is Nothing Then
            Return
        End If
        If nextCell.Character IsNot Nothing Then
            Return
        End If
        Select Case nextCell.Terrain
            Case TerrainType.Water
                Return
        End Select
        nextCell.Character = currentCell.Character
        currentCell.Character = Nothing
        Player.X += deltaX
        Player.Y += deltaY
    End Sub

    Public Sub MoveSouth() Implements IWorld.MoveSouth
        MovePlayer(0, 1)
    End Sub

    Public Sub MoveWest() Implements IWorld.MoveWest
        MovePlayer(-1, 0)
    End Sub

    Public Sub MoveEast() Implements IWorld.MoveEast
        MovePlayer(1, 0)
    End Sub
End Class
